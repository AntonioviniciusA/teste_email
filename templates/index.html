<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Classificação de Emails</title>
    <style>
      :root {
        --primary-color: #3498db;
        --secondary-color: #2980b9;
        --success-color: #27ae60;
        --warning-color: #e74c3c;
        --neutral-color: #f39c12;
        --light-color: #f5f5f5;
        --dark-color: #333;
        --gray-color: #95a5a6;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f0f2f5;
        color: var(--dark-color);
        line-height: 1.6;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: var(--primary-color);
        margin-bottom: 10px;
      }

      .description {
        color: var(--gray-color);
        font-size: 1.1rem;
      }

      .upload-section,
      .result-section,
      .criteria-section {
        background-color: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        margin-bottom: 20px;
        color: var(--secondary-color);
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .upload-options {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .upload-option {
        border: 2px dashed var(--gray-color);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .upload-option:hover {
        border-color: var(--primary-color);
        background-color: rgba(52, 152, 219, 0.05);
      }

      .upload-option.active {
        border-color: var(--primary-color);
        background-color: rgba(52, 152, 219, 0.1);
      }

      .file-input {
        display: none;
      }

      .text-input {
        width: 100%;
        height: 150px;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        resize: vertical;
        font-size: 1rem;
      }

      .file-info {
        margin-top: 10px;
        font-size: 0.9rem;
        color: var(--gray-color);
      }

      .btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: background-color 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .btn:hover {
        background-color: var(--secondary-color);
      }

      .btn:disabled {
        background-color: var(--gray-color);
        cursor: not-allowed;
      }

      .btn-secondary {
        background-color: var(--gray-color);
      }

      .btn-secondary:hover {
        background-color: #7f8c8d;
      }

      .btn-container {
        text-align: center;
        margin-top: 20px;
      }

      .result-container {
        display: none;
      }

      .classification {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 8px;
        background-color: var(--light-color);
      }

      .classification-label {
        font-weight: bold;
        font-size: 1.1rem;
      }

      .classification-value {
        padding: 5px 15px;
        border-radius: 20px;
        color: white;
        font-weight: bold;
      }

      .productive {
        background-color: var(--success-color);
      }

      .unproductive {
        background-color: var(--warning-color);
      }

      .neutral {
        background-color: var(--neutral-color);
      }

      .score-display {
        margin-left: auto;
        font-weight: bold;
        color: var(--dark-color);
      }

      .reasons-list {
        margin: 15px 0;
        padding-left: 20px;
      }

      .reasons-list li {
        margin-bottom: 8px;
        padding: 5px;
        background-color: #f8f9fa;
        border-radius: 4px;
      }

      .response-box {
        background-color: var(--light-color);
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
        margin-bottom: 15px;
      }

      .response-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: var(--secondary-color);
      }

      .response-content {
        white-space: pre-wrap;
        line-height: 1.5;
      }

      .criteria-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .criteria-group {
        margin-bottom: 20px;
      }

      .criteria-group h4 {
        margin-bottom: 10px;
        color: var(--secondary-color);
      }

      .criteria-textarea {
        width: 100%;
        height: 120px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        resize: vertical;
        font-size: 0.9rem;
      }

      .criteria-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .error-message {
        color: var(--warning-color);
        text-align: center;
        margin-top: 15px;
        padding: 10px;
        background-color: rgba(231, 76, 60, 0.1);
        border-radius: 5px;
        display: none;
      }

      .success-message {
        color: var(--success-color);
        text-align: center;
        margin-top: 15px;
        padding: 10px;
        background-color: rgba(39, 174, 96, 0.1);
        border-radius: 5px;
        display: none;
      }

      .processed-text {
        margin-top: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        font-size: 0.9rem;
        color: #666;
      }

      .tab-buttons {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
      }

      .tab-button {
        padding: 12px 24px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
      }

      .tab-button.active {
        border-bottom-color: var(--primary-color);
        color: var(--primary-color);
        font-weight: bold;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      @media (max-width: 768px) {
        .criteria-form {
          grid-template-columns: 1fr;
        }

        .container {
          padding: 10px;
        }

        .upload-option {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Sistema de Classificação de Emails</h1>
        <p class="description">
          Classifique emails com critérios personalizáveis e gere respostas
          automáticas
        </p>
      </header>

      <div class="tab-buttons">
        <button class="tab-button active" data-tab="upload">
          Analisar Email
        </button>
        <button class="tab-button" data-tab="criteria">
          Gerenciar Critérios
        </button>
      </div>

      <div class="tab-content active" id="upload-tab">
        <section class="upload-section">
          <h2 class="section-title">Enviar Email para Análise</h2>

          <form id="upload-form">
            <div class="upload-options">
              <div class="upload-option" id="file-option">
                <h3>Upload de Arquivo</h3>
                <p>Selecione um arquivo .txt ou .pdf</p>
                <input
                  type="file"
                  id="file-input"
                  class="file-input"
                  name="file"
                  accept=".txt,.pdf"
                />
                <div class="file-info" id="file-info">
                  Nenhum arquivo selecionado
                </div>
                <button type="button" class="btn" id="select-file-btn">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    viewBox="0 0 16 16"
                  >
                    <path
                      d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"
                    />
                    <path
                      d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"
                    />
                  </svg>
                  Selecionar Arquivo
                </button>
              </div>

              <div class="upload-option" id="text-option">
                <h3>Texto Direto</h3>
                <p>Cole o conteúdo do email abaixo</p>
                <textarea
                  id="text-input"
                  class="text-input"
                  name="text"
                  placeholder="Cole o conteúdo do email aqui..."
                ></textarea>
              </div>
            </div>

            <div class="btn-container">
              <button type="submit" class="btn" id="process-btn" disabled>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM7 11.5a.5.5 0 0 1-1 0V6.707L5.354 7.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L7 6.707V11.5z"
                  />
                </svg>
                Processar Email
              </button>
            </div>
          </form>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analisando o email...</p>
          </div>

          <div class="error-message" id="error-message">
            Ocorreu um erro ao processar o email. Tente novamente.
          </div>
        </section>

        <section class="result-section" id="result-section">
          <h2 class="section-title">Resultado da Análise</h2>

          <div class="result-container" id="result-container">
            <div class="classification">
              <span class="classification-label">Categoria:</span>
              <span class="classification-value" id="category-value"
                >Produtivo</span
              >
              <div class="score-display">
                Score: <span id="score-value">0</span>
              </div>
            </div>

            <div class="reasons">
              <h4>Razões da Classificação:</h4>
              <ul class="reasons-list" id="reasons-list"></ul>
            </div>

            <div class="response-box">
              <div class="response-title">Resposta Automática Sugerida:</div>
              <div class="response-content" id="response-content">
                Obrigado pelo seu email. Analisaremos sua solicitação e
                retornaremos em breve.
              </div>
            </div>

            <div class="processed-text">
              <strong>Texto processado:</strong>
              <span id="processed-text"></span>
            </div>
          </div>
        </section>
      </div>

      <div class="tab-content" id="criteria-tab">
        <section class="criteria-section">
          <h2 class="section-title">
            Gerenciar Critérios de Classificação
            <button class="btn btn-secondary" id="reset-criteria-btn">
              Restaurar Padrão
            </button>
          </h2>

          <form id="criteria-form">
            <div class="criteria-form">
              <div class="criteria-group">
                <h4>📈 Palavras que Tornam Email Produtivo</h4>
                <textarea
                  class="criteria-textarea"
                  id="productive-keywords"
                  placeholder="Digite uma palavra por linha...&#10;Exemplo:&#10;reunião&#10;projeto&#10;relatório&#10;prazo"
                ></textarea>
                <small
                  >Cada palavra adiciona pontos positivos na
                  classificação</small
                >
              </div>

              <div class="criteria-group">
                <h4>📉 Palavras que Tornam Email Improdutivo</h4>
                <textarea
                  class="criteria-textarea"
                  id="unproductive-keywords"
                  placeholder="Digite uma palavra por linha...&#10;Exemplo:&#10;spam&#10;oferta&#10;promoção&#10;grátis"
                ></textarea>
                <small
                  >Cada palavra adiciona pontos negativos na
                  classificação</small
                >
              </div>

              <div class="criteria-group">
                <h4>🔗 Combinações Produtivas (Contexto)</h4>
                <div class="combinations-info">
                  <p>
                    O sistema automaticamente criará padrões quando estas
                    palavras aparecerem juntas:
                  </p>

                  <div class="combination-group">
                    <label>Quando aparecerem juntas:</label>
                    <input
                      type="text"
                      class="criteria-input combination-input"
                      id="combo-words-1"
                      placeholder="projeto, tarefa, atividade"
                      value="projeto, tarefa, atividade"
                    />
                    <label>Com estas ações:</label>
                    <input
                      type="text"
                      class="criteria-input combination-input"
                      id="combo-actions-1"
                      placeholder="prazo, data, entrega"
                      value="prazo, data, entrega"
                    />
                  </div>

                  <div class="combination-group">
                    <label>Quando aparecerem juntas:</label>
                    <input
                      type="text"
                      class="criteria-input combination-input"
                      id="combo-words-2"
                      placeholder="reunião, encontro"
                      value="reunião, encontro"
                    />
                    <label>Com estas ações:</label>
                    <input
                      type="text"
                      class="criteria-input combination-input"
                      id="combo-actions-2"
                      placeholder="agenda, agendar, marcar"
                      value="agenda, agendar, marcar"
                    />
                  </div>

                  <div class="combination-group">
                    <label>Quando aparecerem juntas:</label>
                    <input
                      type="text"
                      class="criteria-input combination-input"
                      id="combo-words-3"
                      placeholder="relatório, documento, análise"
                      value="relatório, documento, análise"
                    />
                    <label>Com estas ações:</label>
                    <input
                      type="text"
                      class="criteria-input combination-input"
                      id="combo-actions-3"
                      placeholder="entregar, enviar, preparar"
                      value="entregar, enviar, preparar"
                    />
                  </div>
                </div>
                <small
                  >Estas combinações dão mais pontos que palavras
                  isoladas</small
                >
              </div>

              <div class="criteria-group">
                <h4>⚙️ Configurações Gerais</h4>
                <div style="display: grid; gap: 15px">
                  <div>
                    <label>Comprimento Mínimo do Email (caracteres):</label>
                    <input
                      type="number"
                      class="criteria-input"
                      id="min-length"
                      min="1"
                      max="1000"
                      value="50"
                    />
                  </div>
                  <div>
                    <label>Comprimento Máximo do Email (caracteres):</label>
                    <input
                      type="number"
                      class="criteria-input"
                      id="max-length"
                      min="100"
                      max="10000"
                      value="5000"
                    />
                  </div>
                  <div>
                    <label>Pontos por palavra produtiva:</label>
                    <input
                      type="number"
                      class="criteria-input"
                      id="productive-weight"
                      min="1"
                      max="10"
                      value="2"
                    />
                  </div>
                  <div>
                    <label>Pontos por palavra improdutiva:</label>
                    <input
                      type="number"
                      class="criteria-input"
                      id="unproductive-weight"
                      min="1"
                      max="10"
                      value="3"
                    />
                  </div>
                </div>
              </div>
            </div>

            <div class="btn-container">
              <button type="submit" class="btn" id="save-criteria-btn">
                💾 Salvar Critérios
              </button>
            </div>
          </form>

          <div class="success-message" id="criteria-success-message">
            Critérios salvos com sucesso!
          </div>

          <div class="error-message" id="criteria-error-message">
            Erro ao salvar critérios.
          </div>
        </section>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Elementos da interface
        const uploadForm = document.getElementById("upload-form");
        const fileOption = document.getElementById("file-option");
        const textOption = document.getElementById("text-option");
        const fileInput = document.getElementById("file-input");
        const selectFileBtn = document.getElementById("select-file-btn");
        const fileInfo = document.getElementById("file-info");
        const textInput = document.getElementById("text-input");
        const processBtn = document.getElementById("process-btn");
        const loading = document.getElementById("loading");
        const errorMessage = document.getElementById("error-message");
        const resultContainer = document.getElementById("result-container");
        const categoryValue = document.getElementById("category-value");
        const scoreValue = document.getElementById("score-value");
        const reasonsList = document.getElementById("reasons-list");
        const responseContent = document.getElementById("response-content");
        const processedText = document.getElementById("processed-text");

        // Elementos do gerenciador de critérios
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");
        const criteriaForm = document.getElementById("criteria-form");
        const productiveKeywords = document.getElementById(
          "productive-keywords"
        );
        const unproductiveKeywords = document.getElementById(
          "unproductive-keywords"
        );
        const requiredPatterns = document.getElementById("required-patterns");
        const minLength = document.getElementById("min-length");
        const maxLength = document.getElementById("max-length");
        const resetCriteriaBtn = document.getElementById("reset-criteria-btn");
        const criteriaSuccessMessage = document.getElementById(
          "criteria-success-message"
        );
        const criteriaErrorMessage = document.getElementById(
          "criteria-error-message"
        );

        // Estado da aplicação
        let currentOption = "text";
        let selectedFile = null;

        // Inicialização
        loadCriteria();
        setupEventListeners();

        function setupEventListeners() {
          // Abas
          tabButtons.forEach((button) => {
            button.addEventListener("click", function () {
              const tabId = this.getAttribute("data-tab");
              switchTab(tabId);
            });
          });

          // Upload de arquivo
          selectFileBtn.addEventListener("click", function () {
            fileInput.click();
          });

          fileInput.addEventListener("change", function (e) {
            if (e.target.files.length > 0) {
              selectedFile = e.target.files[0];
              fileInfo.textContent = `Arquivo selecionado: ${selectedFile.name}`;
              setActiveOption("file");
              validateInput();
            }
          });

          textInput.addEventListener("input", function () {
            setActiveOption("text");
            validateInput();
          });

          fileOption.addEventListener("click", function () {
            fileInput.click();
          });

          textOption.addEventListener("click", function () {
            setActiveOption("text");
            textInput.focus();
          });

          uploadForm.addEventListener("submit", function (e) {
            e.preventDefault();
            processEmail();
          });

          // Gerenciador de critérios
          criteriaForm.addEventListener("submit", function (e) {
            e.preventDefault();
            saveCriteria();
          });

          resetCriteriaBtn.addEventListener("click", function () {
            if (
              confirm(
                "Restaurar critérios padrão? Isso substituirá suas configurações atuais."
              )
            ) {
              resetCriteria();
            }
          });
        }

        function switchTab(tabId) {
          // Atualizar botões da aba
          tabButtons.forEach((button) => {
            button.classList.toggle(
              "active",
              button.getAttribute("data-tab") === tabId
            );
          });

          // Atualizar conteúdo da aba
          tabContents.forEach((content) => {
            content.classList.toggle("active", content.id === `${tabId}-tab`);
          });
        }

        function setActiveOption(option) {
          currentOption = option;

          if (option === "file") {
            fileOption.classList.add("active");
            textOption.classList.remove("active");
          } else {
            textOption.classList.add("active");
            fileOption.classList.remove("active");
          }

          validateInput();
        }

        function validateInput() {
          if (currentOption === "file") {
            processBtn.disabled = !selectedFile;
          } else {
            processBtn.disabled = textInput.value.trim() === "";
          }
        }

        function processEmail() {
          // Mostrar loading
          loading.style.display = "block";
          errorMessage.style.display = "none";
          resultContainer.style.display = "none";

          // Criar FormData
          const formData = new FormData();

          if (currentOption === "file" && selectedFile) {
            formData.append("file", selectedFile);
          } else {
            formData.append("text", textInput.value);
          }

          // Enviar para o backend
          fetch("/upload", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              loading.style.display = "none";

              if (data.error) {
                showError(data.error);
              } else {
                displayResults(data);
              }
            })
            .catch((error) => {
              loading.style.display = "none";
              showError("Erro de conexão com o servidor");
              console.error("Error:", error);
            });
        }

        function displayResults(data) {
          // Atualizar categoria
          categoryValue.textContent = data.classification;
          categoryValue.className =
            "classification-value " +
            (data.classification === "Produtivo"
              ? "productive"
              : data.classification === "Improdutivo"
              ? "unproductive"
              : "neutral");

          // Atualizar score
          scoreValue.textContent = data.score;

          // Atualizar razões
          reasonsList.innerHTML = "";
          if (data.reasons && data.reasons.length > 0) {
            data.reasons.forEach((reason) => {
              const li = document.createElement("li");
              li.textContent = reason;
              reasonsList.appendChild(li);
            });
          }

          // Atualizar resposta
          responseContent.textContent = data.response;

          // Atualizar texto processado
          processedText.textContent =
            data.processed_text || "Texto processado não disponível";

          // Mostrar resultados
          resultContainer.style.display = "block";

          // Rolar para os resultados
          resultContainer.scrollIntoView({ behavior: "smooth" });
        }

        function showError(message) {
          errorMessage.textContent = message;
          errorMessage.style.display = "block";
        }

        function loadCriteria() {
          fetch("/criteria")
            .then((response) => response.json())
            .then((criteria) => {
              // Preencher formulário com critérios atuais
              productiveKeywords.value =
                criteria.productive_keywords.join("\n");
              unproductiveKeywords.value =
                criteria.unproductive_keywords.join("\n");
              requiredPatterns.value = criteria.required_patterns.join("\n");
              minLength.value = criteria.min_length;
              maxLength.value = criteria.max_length;
            })
            .catch((error) => {
              console.error("Erro ao carregar critérios:", error);
            });
        }

        function saveCriteria() {
          const criteria = {
            productive_keywords: productiveKeywords.value
              .split("\n")
              .filter((k) => k.trim()),
            unproductive_keywords: unproductiveKeywords.value
              .split("\n")
              .filter((k) => k.trim()),
            required_patterns: requiredPatterns.value
              .split("\n")
              .filter((p) => p.trim()),
            min_length: parseInt(minLength.value),
            max_length: parseInt(maxLength.value),
          };

          fetch("/criteria", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(criteria),
          })
            .then((response) => response.json())
            .then((result) => {
              if (result.success) {
                showCriteriaSuccess("Critérios salvos com sucesso!");
              } else {
                showCriteriaError(result.error || "Erro ao salvar critérios");
              }
            })
            .catch((error) => {
              console.error("Erro:", error);
              showCriteriaError("Erro de conexão ao salvar critérios");
            });
        }

        function resetCriteria() {
          // Restaurar valores padrão
          productiveKeywords.value = [
            "reunião",
            "projeto",
            "trabalho",
            "relatório",
            "prazo",
            "cliente",
            "entrega",
            "solicitação",
            "orçamento",
            "contrato",
            "desenvolvimento",
            "apresentação",
            "análise",
            "negócio",
            "empresa",
          ].join("\n");

          unproductiveKeywords.value = [
            "spam",
            "promoção",
            "oferta",
            "desconto",
            "newsletter",
            "corrente",
            "loteria",
            "prêmio",
            "ganhador",
            "grátis",
            "urgente",
            "importante",
          ].join("\n");

          requiredPatterns.value = [
            "\\b(projeto|tarefa|atividade)\\b.*\\b(prazo|data|entrega)\\b",
            "\\b(reunião|encontro)\\b.*\\b(agenda|agendar|marcar)\\b",
            "\\b(relatório|documento|análise)\\b.*\\b(entregar|enviar|preparar)\\b",
            "\\b(solicitação|pedido|requisição)\\b.*\\b(resposta|retorno|feedback)\\b",
            "\\b(desenvolvimento|implementação)\\b.*\\b(código|sistema|módulo)\\b",
          ].join("\n");
          minLength.value = 50;
          maxLength.value = 5000;

          showCriteriaSuccess(
            'Critérios restaurados para os valores padrão. Clique em "Salvar Critérios" para aplicar.'
          );
        }

        function showCriteriaSuccess(message) {
          criteriaSuccessMessage.textContent = message;
          criteriaSuccessMessage.style.display = "block";
          criteriaErrorMessage.style.display = "none";

          setTimeout(() => {
            criteriaSuccessMessage.style.display = "none";
          }, 5000);
        }

        function showCriteriaError(message) {
          criteriaErrorMessage.textContent = message;
          criteriaErrorMessage.style.display = "block";
          criteriaSuccessMessage.style.display = "none";

          setTimeout(() => {
            criteriaErrorMessage.style.display = "none";
          }, 5000);
        }

        // Inicialização
        setActiveOption("text");
      });

      // Função para gerar padrões automaticamente das combinações
      function generatePatternsFromCombinations() {
        const patterns = [];

        // Combinação 1: Projeto/Tarefa + Prazo/Entrega
        const combo1Words = document
          .getElementById("combo-words-1")
          .value.split(",")
          .map((w) => w.trim())
          .filter((w) => w);
        const combo1Actions = document
          .getElementById("combo-actions-1")
          .value.split(",")
          .map((w) => w.trim())
          .filter((w) => w);

        if (combo1Words.length > 0 && combo1Actions.length > 0) {
          const pattern = `\\b(${combo1Words.join(
            "|"
          )})\\b.*\\b(${combo1Actions.join("|")})\\b`;
          patterns.push(pattern);
        }

        // Combinação 2: Reunião/Encontro + Agenda/Marcar
        const combo2Words = document
          .getElementById("combo-words-2")
          .value.split(",")
          .map((w) => w.trim())
          .filter((w) => w);
        const combo2Actions = document
          .getElementById("combo-actions-2")
          .value.split(",")
          .map((w) => w.trim())
          .filter((w) => w);

        if (combo2Words.length > 0 && combo2Actions.length > 0) {
          const pattern = `\\b(${combo2Words.join(
            "|"
          )})\\b.*\\b(${combo2Actions.join("|")})\\b`;
          patterns.push(pattern);
        }

        // Combinação 3: Relatório/Documento + Entregar/Enviar
        const combo3Words = document
          .getElementById("combo-words-3")
          .value.split(",")
          .map((w) => w.trim())
          .filter((w) => w);
        const combo3Actions = document
          .getElementById("combo-actions-3")
          .value.split(",")
          .map((w) => w.trim())
          .filter((w) => w);

        if (combo3Words.length > 0 && combo3Actions.length > 0) {
          const pattern = `\\b(${combo3Words.join(
            "|"
          )})\\b.*\\b(${combo3Actions.join("|")})\\b`;
          patterns.push(pattern);
        }

        return patterns;
      }

      // Função para salvar critérios (atualizada)
      function saveCriteria() {
        const productiveKeywords = document
          .getElementById("productive-keywords")
          .value.split("\n")
          .filter((k) => k.trim());
        const unproductiveKeywords = document
          .getElementById("unproductive-keywords")
          .value.split("\n")
          .filter((k) => k.trim());
        const requiredPatterns = generatePatternsFromCombinations();

        const criteria = {
          productive_keywords: productiveKeywords,
          unproductive_keywords: unproductiveKeywords,
          required_patterns: requiredPatterns,
          min_length: parseInt(document.getElementById("min-length").value),
          max_length: parseInt(document.getElementById("max-length").value),
          productive_weight: parseInt(
            document.getElementById("productive-weight").value
          ),
          unproductive_weight: parseInt(
            document.getElementById("unproductive-weight").value
          ),
        };

        fetch("/criteria", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(criteria),
        })
          .then((response) => response.json())
          .then((result) => {
            if (result.success) {
              showCriteriaSuccess("Critérios salvos com sucesso!");
            } else {
              showCriteriaError(result.error || "Erro ao salvar critérios");
            }
          })
          .catch((error) => {
            console.error("Erro:", error);
            showCriteriaError("Erro de conexão ao salvar critérios");
          });
      }

      // Função para carregar critérios (atualizada)
      function loadCriteria() {
        fetch("/criteria")
          .then((response) => response.json())
          .then((criteria) => {
            // Palavras simples
            document.getElementById("productive-keywords").value =
              criteria.productive_keywords.join("\n");
            document.getElementById("unproductive-keywords").value =
              criteria.unproductive_keywords.join("\n");

            // Configurações gerais
            document.getElementById("min-length").value = criteria.min_length;
            document.getElementById("max-length").value = criteria.max_length;
            document.getElementById("productive-weight").value =
              criteria.productive_weight || 2;
            document.getElementById("unproductive-weight").value =
              criteria.unproductive_weight || 3;
          })
          .catch((error) => {
            console.error("Erro ao carregar critérios:", error);
          });
      }

      // Função para resetar critérios (atualizada)
      function resetCriteria() {
        if (
          confirm(
            "Restaurar critérios padrão? Isso substituirá suas configurações atuais."
          )
        ) {
          // Palavras produtivas
          document.getElementById("productive-keywords").value = [
            "reunião",
            "projeto",
            "trabalho",
            "relatório",
            "prazo",
            "cliente",
            "entrega",
            "solicitação",
            "orçamento",
            "contrato",
            "desenvolvimento",
            "apresentação",
            "análise",
            "negócio",
            "empresa",
            "equipe",
            "gestão",
          ].join("\n");

          // Palavras improdutivas
          document.getElementById("unproductive-keywords").value = [
            "spam",
            "promoção",
            "oferta",
            "desconto",
            "newsletter",
            "corrente",
            "loteria",
            "prêmio",
            "ganhador",
            "grátis",
            "urgente",
            "importante",
          ].join("\n");

          // Combinações
          document.getElementById("combo-words-1").value =
            "projeto, tarefa, atividade";
          document.getElementById("combo-actions-1").value =
            "prazo, data, entrega";

          document.getElementById("combo-words-2").value = "reunião, encontro";
          document.getElementById("combo-actions-2").value =
            "agenda, agendar, marcar";

          document.getElementById("combo-words-3").value =
            "relatório, documento, análise";
          document.getElementById("combo-actions-3").value =
            "entregar, enviar, preparar";

          // Configurações
          document.getElementById("min-length").value = 50;
          document.getElementById("max-length").value = 5000;
          document.getElementById("productive-weight").value = 2;
          document.getElementById("unproductive-weight").value = 3;

          showCriteriaSuccess(
            'Critérios restaurados para os valores padrão. Clique em "Salvar Critérios" para aplicar.'
          );
        }
      }
    </script>
  </body>
</html>
